<%layout("layouts/boilerplate.ejs")%>
<body class="d-flex align-items-center justify-content-center">

    <div class="container my-5 bg-light p-4">
        <div class="text-center mb-4">
            <h1 class="display-4 fw-bold text-dark"> Review The Law Made For You </h1>
            <p class="mt-2 fs-5 text-secondary">Review and provide feedback on proposed laws.</p>
        </div>
        
        <div class="card shadow-sm p-3 mb-4 text-center section-card">
            <h3 class="fs-5 fw-bold text-secondary mb-2">Poll Status</h3>
            <p class="mb-0 fs-6 text-muted"><strong>Starts:</strong> <%=law.createdAt.toLocaleDateString()%></p>
            <p class="mb-0 fs-6 text-muted"><strong>Ends:</strong> <%= law.endTime.toLocaleDateString() %></p>
        </div>

        <div class="card shadow-sm p-4 mb-4 section-card">
            <h2 class="fs-4 fw-bold text-secondary mb-3">Proposed Law: <%=law.title%></h2>
            <div class="mb-3 text-muted">
                <p><strong>Proposed by:</strong> <%=law.proposedBy%></p>
                <p><strong>Main Field:</strong> <%=law.mainField%></p>
                <p><strong>Related Classes:</strong> <%=law.relatedClasses%></p>
            </div>
            <p class="text-muted lh-base"><strong>Description:</strong>
                <%=law.description%></p>
        </div>

        <div class="card shadow-sm p-4 mb-4 section-card">
            <h2 class="fs-4 fw-bold text-secondary mb-3">Your Review</h2>
            <form id="reviewForm" action="/review/<%=law._id%>" method="post" class="needs-validation" novalidate>
                <div class="mb-4">
                    <p class="fs-5 fw-medium text-secondary mb-2">What is your opinion on this law?</p>
                    <div class="d-flex align-items-center gap-3">
                        <input type="radio" id="support" name="review_option" value="support" class="d-none radio-input" required>
                        <label for="support" class="btn btn-outline-secondary rounded-pill fw-medium px-4 py-2 radio-label">Support</label>

                        <input type="radio" id="neutral" name="review_option" value="neutral" class="d-none radio-input">
                        <label for="neutral" class="btn btn-outline-secondary rounded-pill fw-medium px-4 py-2 radio-label">Neutral</label>

                        <input type="radio" id="oppose" name="review_option" value="oppose" class="d-none radio-input">
                        <label for="oppose" class="btn btn-outline-secondary rounded-pill fw-medium px-4 py-2 radio-label">Oppose</label>
                    </div>
                     <div class="invalid-feedback d-none" id="review-option-feedback">
                        Please select an option.
                    </div>
                </div>

                <div class="mb-4">
                    <label for="reason" class="form-label fs-5 fw-medium text-secondary mb-2">Please elaborate on your review (mandatory):</label>
                    <textarea id="reason" name="reason" rows="4" class="form-control" placeholder="Explain your reasons here..." required></textarea>
                    <div class="invalid-feedback">
                        Please provide your reasons for the review.
                    </div>
                </div>

                <div class="mb-4">
                    <label for="impact" class="form-label fs-5 fw-medium text-secondary mb-2">How does this law affect you? (optional):</label>
                    <textarea id="impact" name="impact" rows="4" class="form-control" placeholder="Describe the personal or professional impact..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="suggestion" class="form-label fs-5 fw-medium text-secondary mb-2">Suggestions for improvement (optional):</label>
                    <textarea id="suggestion" name="suggestion" rows="4" class="form-control" placeholder="Suggest improvements or alternatives..."></textarea>
                </div>

                <div class="d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary rounded-pill px-5 py-2 fw-semibold shadow-sm transition-transform" style="background-color: #3880ff; border-color: #3880ff;">
                        Submit Your Review
                    </button>
                    &nbsp;&nbsp;
                    <a href="/law/<%=law._id%>" class="btn btn-secondary rounded-pill px-5 py-2 fw-semibold shadow-sm transition-transform">
                        Back
                    </a>
                </div> 
            </form>
        </div>

        <div id="submissionMessage" class="d-none card p-4 mb-4 text-center section-card">
            <h2 class="fs-4 fw-bold text-secondary mb-3">Thank you for your feedback!</h2>
            <p class="text-muted">Your review has been submitted successfully.</p>
        </div>

        <div id="resultsSection" class="d-none card p-4 section-card">
            <h2 class="fs-4 fw-bold text-secondary mb-3">Live Review Results</h2>
            <div class="d-flex flex-column gap-3">
                <div class="d-flex align-items-center gap-3">
                    <span class="text-secondary fw-medium">Support:</span>
                    <div class="progress flex-grow-1 rounded-pill" style="height: 25px;">
                        <div id="supportBar" class="progress-bar" role="progressbar" style="width: 0%; background-color: #22c55e;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span id="supportCount" class="text-secondary fw-semibold">0%</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-secondary fw-medium">Neutral:</span>
                    <div class="progress flex-grow-1 rounded-pill" style="height: 25px;">
                        <div id="neutralBar" class="progress-bar" role="progressbar" style="width: 0%; background-color: #eab308;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span id="neutralCount" class="text-secondary fw-semibold">0%</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-secondary fw-medium">Oppose:</span>
                    <div class="progress flex-grow-1 rounded-pill" style="height: 25px;">
                        <div id="disagreeBar" class="progress-bar" role="progressbar" style="width: 0%; background-color: #ef4444;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <span id="disagreeCount" class="text-secondary fw-semibold">0%</span>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="javascript/script.js"></script>
    <style>
        .radio-input:checked + .radio-label {
            background-color: #3880ff;
            color: white;
            border-color: #3880ff;
        }
    </style>
    <script>
        (function () {
            'use strict'
            const form = document.getElementById('reviewForm');
            const reviewOptionRadios = document.getElementsByName('review_option');
            const reasonTextarea = document.getElementById('reason');
            const reviewOptionFeedback = document.getElementById('review-option-feedback');

            form.addEventListener('submit', event => {
                let isRadioChecked = Array.from(reviewOptionRadios).some(radio => radio.checked);
                let isReasonFilled = reasonTextarea.value.trim() !== '';

                if (!isRadioChecked || !isReasonFilled) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                if (!isRadioChecked) {
                    reviewOptionFeedback.classList.remove('d-none');
                } else {
                    reviewOptionFeedback.classList.add('d-none');
                }

                form.classList.add('was-validated');
            }, false);

            Array.from(reviewOptionRadios).forEach(radio => {
                radio.addEventListener('change', () => {
                    reviewOptionFeedback.classList.add('d-none');
                });
            });
        })()
    </script>
</body>